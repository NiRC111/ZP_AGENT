<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Government Quasi-Judicial AI System ‚Äî Zilla Parishad Chandrapur</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js';
</script>

<!-- Mammoth (DOCX) -->
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

<!-- Tesseract OCR -->
<script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>

<style>
body{font-family:'Roboto','Noto Sans Devanagari',sans-serif;background:linear-gradient(135deg,#FF9933 0%,#FFFFFF 50%,#138808 100%);margin:0;min-height:100vh}
header{background:#fff;border-bottom:3px solid #FF9933;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.titles .marathi{font-size:22px;font-weight:800;color:#FF9933}
.titles .english{font-size:18px;font-weight:700;color:#333}
.tabs{display:flex;gap:10px;background:#fff;margin:18px;padding:10px;border-radius:10px}
.tabs button{flex:1;padding:12px;border:none;border-radius:8px;background:#f0f0f0;font-weight:700;cursor:pointer}
.tabs button.active{background:linear-gradient(135deg,#FF9933,#FF6B00);color:#fff}
.panel{background:#fff;margin:18px;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
.form-group{margin-bottom:14px}
.form-group label{font-weight:700;margin-bottom:6px;display:block}
.form-group input,.form-group textarea,.form-group select{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px}
.actions{display:flex;gap:12px;margin:18px;flex-wrap:wrap}
.actions button{padding:12px 20px;border:none;border-radius:8px;color:#fff;font-weight:700;cursor:pointer}
.analyze{background:linear-gradient(135deg,#667eea,#764ba2)}
.decision{background:linear-gradient(135deg,#f093fb,#f5576c)}
.order{background:linear-gradient(135deg,#4facfe,#00f2fe)}
.print{background:linear-gradient(135deg,#43e97b,#38f9d7)}
.output{display:none;background:#fff;margin:18px;padding:20px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08)}
.output pre{white-space:pre-wrap;line-height:1.8;font-size:15px;color:#222}
.status{margin:0 18px;padding:12px;border-radius:8px;display:none}
.status.show{display:block}
.loading{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;justify-content:center;align-items:center;z-index:9999}
.loading.show{display:flex}
.box{background:#fff;padding:28px;border-radius:12px;text-align:center}
</style>
</head>

<body>
<header>
  <div class="titles">
    <div class="marathi">‡§ú‡§ø‡§≤‡•ç‡§π‡§æ ‡§™‡§∞‡§ø‡§∑‡§¶ ‡§ö‡§Ç‡§¶‡•ç‡§∞‡§™‡•Ç‡§∞</div>
    <div class="english">ZILLA PARISHAD CHANDRAPUR</div>
    <div style="font-size:12px;color:#555">Office of the Chief Executive Officer</div>
  </div>
  <div style="font-size:12px;color:#666">üîí Secure Government Portal</div>
</header>

<div class="tabs">
  <button class="active" onclick="tab('docs',event)">üìÅ Documents</button>
  <button onclick="tab('case',event)">‚öñÔ∏è Case Details</button>
  <button onclick="tab('analysis',event)">üìä AI Analysis</button>
  <button onclick="tab('out',event)">üìã Output</button>
  <select id="lang" style="margin-left:auto;border:2px solid #ddd;border-radius:8px;padding:10px">
    <option value="marathi">‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
    <option value="english">English</option>
  </select>
</div>

<!-- Documents -->
<div id="docs" class="panel tab">
  <h3>üìÅ Upload Documents</h3>
  <div class="form-group">
    <label>Case File (PDF/DOCX/Image) <span style="color:#e74c3c">*</span></label>
    <input id="caseFile" type="file" accept=".pdf,.docx,image/*" />
  </div>
  <div class="form-group">
    <label>Government Resolution (GR) (PDF/DOCX/Image) <span style="color:#e74c3c">*</span></label>
    <input id="grFile" type="file" accept=".pdf,.docx,image/*" />
  </div>
  <div class="form-group">
    <label>Additional Legal Docs (optional)</label>
    <input id="legalFiles" type="file" accept=".pdf,.docx,image/*" multiple />
  </div>
</div>

<!-- Case Details -->
<div id="case" class="panel tab" style="display:none">
  <h3>‚öñÔ∏è Case Details</h3>
  <div class="form-group"><label>Case Number</label><input id="caseNumber" placeholder="ZP/CEO/2025/123"/></div>
  <div class="form-group"><label>Applicant Name</label><input id="applicantName" placeholder="e.g., Indubai Hadar Rathod"/></div>
  <div class="form-group"><label>Specific Legal Sections / Rules</label><input id="legalSections" placeholder="e.g., GR 02/02/2023; MCS Rules; RTI S.19"/></div>
  <div class="form-group"><label>Brief Case Description</label><textarea id="caseDescription" rows="4"></textarea></div>
</div>

<!-- AI Analysis -->
<div id="analysis" class="panel tab" style="display:none">
  <h3>üìä AI Analysis</h3>
  <pre id="analysisBox" style="background:#f8f9fa;border:1px solid #eee;padding:14px;border-radius:10px">Upload Case+GR and click Analyze</pre>
</div>

<!-- Actions -->
<div class="actions">
  <button class="analyze" onclick="doAnalyze()">üîç Analyze with AI</button>
  <button class="decision" onclick="doDecision()">üìù Generate Decision</button>
  <button class="order" onclick="doOrder()">üìã Generate Order</button>
  <button class="print" onclick="window.print()">üñ® Print</button>
</div>

<!-- Output -->
<div id="out" class="output tab" style="display:none">
  <h3 id="outTitle">Output</h3>
  <pre id="outText"></pre>
</div>

<div id="status" class="status"></div>

<div id="loading" class="loading"><div class="box"><div>‚è≥ Processing‚Ä¶</div><small>Reading docs & drafting</small></div></div>

<script>
const st = { caseText:"", grText:"", legalText:"" };

function tab(which,ev){
  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.getElementById(which).style.display='block';
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
  if (ev) ev.target.classList.add('active');
}

function showStatus(msg,type="ok"){
  const el = document.getElementById('status');
  el.textContent = msg;
  el.style.background = type==="err" ? "#f8d7da" : type==="warn" ? "#fff3cd" : "#d4edda";
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 5000);
}

const readFileToText = async (file)=>{
  const name = file.name.toLowerCase();
  const ext = name.split('.').pop();
  if (ext==='pdf') return extractPdf(file);
  if (ext==='docx') return extractDocx(file);
  if (['png','jpg','jpeg','webp','tif','tiff','bmp'].includes(ext)) return extractImageOCR(file);
  return await file.text();
};

async function extractPdf(file){
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buf}).promise;
  let out = '';
  for (let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const txt = await page.getTextContent();
    out += txt.items.map(it=>it.str).join(' ') + '\n';
  }
  return out.trim();
}
async function extractDocx(file){
  const arrayBuffer = await file.arrayBuffer();
  const res = await window.mammoth.extractRawText({arrayBuffer});
  return (res && res.value || '').trim();
}
async function extractImageOCR(file){
  const loading = document.getElementById('loading'); loading.classList.add('show');
  try {
    const worker = await Tesseract.createWorker();
    await worker.loadLanguage('eng+hin+mar');
    await worker.initialize('eng+hin+mar');
    const { data:{ text } } = await worker.recognize(file);
    await worker.terminate();
    return text.trim();
  } finally { loading.classList.remove('show'); }
}

async function collectTexts(){
  const caseFile = document.getElementById('caseFile').files[0];
  const grFile   = document.getElementById('grFile').files[0];
  const legalSet = document.getElementById('legalFiles').files;

  if (!caseFile){ showStatus("Please upload Case File","err"); tab('docs'); throw new Error("no case"); }
  if (!grFile){ showStatus("Please upload Government Resolution","err"); tab('docs'); throw new Error("no gr"); }

  const [caseText, grText] = await Promise.all([readFileToText(caseFile), readFileToText(grFile)]);
  let legalText = "";
  if (legalSet && legalSet.length){
    const arr = await Promise.all(Array.from(legalSet).map(f=>readFileToText(f)));
    legalText = arr.join("\n\n");
  }
  st.caseText = caseText;
  st.grText = grText;
  st.legalText = legalText;
}

async function callBackend(kind){
  const lang = document.getElementById('lang').value;
  const payload = {
    language: lang,
    caseText: st.caseText,
    grText: st.grText,
    legalText: st.legalText,
    selectedCaseType: "anganwadi",
    applicantName: document.getElementById('applicantName').value || "",
    caseNumber: document.getElementById('caseNumber').value || "",
    legalSections: document.getElementById('legalSections').value || "",
    caseDescription: document.getElementById('caseDescription').value || ""
  };

  const loading = document.getElementById('loading'); loading.classList.add('show');
  try{
    const resp = await fetch("/api/generate", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if (!resp.ok){ throw new Error("API error"); }
    const data = await resp.json();

    if (kind === "analyze") {
      const f = data.facts || {};
      const lines = [
        "FACTS DETECTED",
        `‚Ä¢ Complainant: ${f.complainant || '‚Äî'}`,
        `‚Ä¢ Village/Taluka: ${f.village || '‚Äî'} / ${f.taluka || '‚Äî'}`,
        `‚Ä¢ Hearing: ${f.hearingDate || '‚Äî'} ${f.hearingTime ? '('+f.hearingTime+')' : ''}`,
        `‚Ä¢ Case No.: ${f.caseNumber || '‚Äî'}`,
        `‚Ä¢ Subject: ${f.subject || '‚Äî'}`,
        "",
        "REFERENCES:",
        ...(Array.isArray(f.references) ? f.references.map((r,i)=>`  ${i+1}. ${r}`) : ['  ‚Äî'])
      ];
      document.getElementById('analysisBox').textContent = lines.join("\n");
      tab('analysis');
      showStatus("Analysis generated");
    }

    if (kind === "decision") {
      document.getElementById('outTitle').innerText = (lang==="marathi"?"‡§®‡§ø‡§∞‡•ç‡§£‡§Ø":"Decision");
      document.getElementById('outText').textContent = data.decisionText || "‚Äî";
      document.getElementById('out').style.display="block";
      tab('out');
      showStatus("Decision drafted");
    }

    if (kind === "order") {
      document.getElementById('outTitle').innerText = (lang==="marathi"?"‡§Ü‡§¶‡•á‡§∂":"Order");
      document.getElementById('outText').textContent = data.orderText || "‚Äî";
      document.getElementById('out').style.display="block";
      tab('out');
      showStatus("Order drafted");
    }

  } catch(e){
    console.error(e);
    showStatus("Backend error. Check API key / deployment.", "err");
  } finally {
    loading.classList.remove('show');
  }
}

async function doAnalyze(){ await collectTexts(); await callBackend("analyze"); }
async function doDecision(){ await collectTexts(); await callBackend("decision"); }
async function doOrder(){ await collectTexts(); await callBackend("order"); }
</script>
</body>
</html>
